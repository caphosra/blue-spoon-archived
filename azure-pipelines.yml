# Publish GitHub Pages

trigger:
  branches:
    include:
      - master
      - refs/tags/*

pool:
  vmImage: 'ubuntu-latest'

variables:
  nodeToolVersion: '12.5.0'
  outFile: 'target'

steps:
- task: NodeTool@0
  inputs:
    versionSpec: $(nodeToolVersion)
  displayName: 'Install node js'

- script: npm install -g typescript
  displayName: 'Install typescript compiler'

- script: tsc
  displayName: 'Compile typescript codes'

- script: |
    pushd tools
    chmod +x bake.sh
    popd
    ./tools/bake.sh
  displayName: 'Bake files'

- script: |
    pushd target
    git init
    git config --local user.name "Bluespoon Bot"
    git config --local user.email "bluespoonbot@capra314cabra.github.io"
    git add .
    git commit -m "Publishing GitHub Pages from $(Build.SourceBranch) ***NO_CI***"
    popd
  displayName: 'Commit compiled changes'
  condition: |
    and(
      ne(variables['Build.Reason'], 'PullRequest'), 
      ne(variables['Build.SourceBranch'], 'refs/heads/master'),
      contains(variables['Build.SourceBranch'], 'refs/tags')
    )
    

- task: DownloadSecureFile@1
  inputs:
    secureFile: bs_github_rsa
  displayName: 'Get the deploy key'
  condition: |
    and(
      ne(variables['Build.Reason'], 'PullRequest'), 
      ne(variables['Build.SourceBranch'], 'refs/heads/master'),
      contains(variables['Build.SourceBranch'], 'refs/tags')
    )

- script: |
    mkdir ~/.ssh && mv $DOWNLOADSECUREFILE_SECUREFILEPATH ~/.ssh/id_rsa
    chmod 700 ~/.ssh && chmod 600 ~/.ssh/id_rsa
    ssh-keyscan -t rsa github.com >> ~/.ssh/known_hosts
    git remote origin git@github.com:capra314cabra/blue-spoon.git
    git push origin gh-pages
  displayName: 'Publish all'
  condition: |
    and(
      ne(variables['Build.Reason'], 'PullRequest'), 
      ne(variables['Build.SourceBranch'], 'refs/heads/master'),
      contains(variables['Build.SourceBranch'], 'refs/tags')
    )
